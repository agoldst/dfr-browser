"use strict";var view=function(){var e={},t={updating:false},i,r,n,o,a,d,s,l,c,u,f,p,w;i=function(e){if(e!==undefined){t.dfb=e}return t.dfb};e.dfb=i;r=function(e){if(typeof e==="boolean"){t.updating=e}return t.updating};e.updating=r;n=function(e,i){if(!t.dirty){t.dirty=d3.set()}if(i===undefined){return t.dirty.has(e)}if(i){t.dirty.add(e)}else{t.dirty.remove(e)}return i};e.dirty=n;o=function(e){d3.select("#working_icon").classed("invisible",!e)};e.loading=o;a=function(e,t){d3.select("#working_icon").classed("invisible",!t);d3.selectAll(e+" .calc").classed("hidden",!t);d3.selectAll(e+" .calc-done").classed("hidden",t)};e.calculating=a;d=function(e){d3.select("div#error").classed("hidden",false).append("p").text(e);this.loading(false);VIS.error=true};e.error=d;s=function(e){d3.select("div#warning").classed("hidden",false).append("p").text(e)};e.warning=s;l=function(){var e=t.tooltip;if(e){return e}e={offset:VIS.tooltip.offset};e.div=d3.select("body").append("div").attr("id","tooltip").classed("bar_tooltip",true);e.container=d3.select("body").node();e.div.append("p");e.update_pos=function(){var e=d3.mouse(this.container);this.div.style({left:e[0]+this.offset.x+"px",top:e[1]+this.offset.y+"px",position:"absolute"})};e.text=function(e){this.div.select("p").text(e)};e.show=function(){this.div.classed("hidden",false)};e.hide=function(){this.div.classed("hidden",true)};t.tooltip=e;return e};e.tooltip=l;c=function(e,t){e.append("td").classed("weight",true).append("div").classed("proportion",true).style("margin-left",function(e){return d3.format(".1%")(1-t(e))}).append("span").classed("proportion",true).html("&nbsp;")};e.append_weight_tds=c;u=function(e,t){var i;if(!VIS.svg){VIS.svg=d3.map()}if(VIS.svg.has(e)){i=VIS.svg.get(e);d3.select(e+" svg").attr("width",t.w+t.m.left+t.m.right).attr("height",t.h+t.m.top+t.m.bottom);i.attr("transform","translate("+t.m.left+","+t.m.top+")")}else{i=f(d3.select(e),t);VIS.svg.set(e,i)}return i};e.plot_svg=u;f=function(e,t){return e.append("svg").attr("width",t.w+t.m.left+t.m.right).attr("height",t.h+t.m.top+t.m.bottom).append("g").attr("transform","translate("+t.m.left+","+t.m.top+")")};e.append_svg=f;p=function(){window.scrollTo(window.scrollX,0)};e.scroll_top=p;w=function(){window.scrollTo(0,0)};e.scroll_origin=w;return e}();"use strict";var VIS={ready:{},last:{bib:{}},files:{info:"data/info.json",meta:"data/meta.csv.zip",dt:"data/dt.json.zip",tw:"data/tw.json",topic_scaled:"data/topic_scaled.csv"},default_view:"/model",overview_words:15,model_view:{w:500,aspect:1.3333,words:4,size_range:[7,18],name_size:18,stroke_range:6,yearly:{w:500,aspect:1.333,m:{left:20,right:20,top:20,bottom:20},label_threshold:40,words:4,label_words:2},list:{spark:{w:70,h:20,m:{left:2,right:2,top:2,bottom:2},bar_width:300}}},topic_view:{words:50,docs:20,w:400,aspect:3,m:{left:40,right:20,top:20,bottom:20},bar_width:90,ticks:10},word_view:{n_min:10,topic_label_padding:8,topic_label_leading:14,row_height:80,svg_rows:10,w:700,m:{left:100,right:40,top:20,bottom:0}},bib:{author_delimiter:"	",et_al:Infinity,anon:"[Anon]"},bib_view:{window_lines:100,major:"year",minor:"authortitle",dir:"up"},float_format:function(e){return d3.round(e,3)},tooltip:{offset:{x:10,y:0}},percent_format:d3.format(".1%"),resize_refresh_delay:100,hidden_topics:[],show_hidden_topics:false,annotes:[],update:function(e){return utils.deep_replace(this,e)}};"use strict";var bib=function(e){var t=e||{},i={},r,n,o,a,d;if(!t.sorting){t.sorting=[["all_raw","by raw entry"]]}r=function(e){if(e!==undefined){r=utils.deep_replace(r,e)}return r};i.options=r;n=function(e){if(e!==undefined){t.sorting=e}return t.sorting};i.sorting=n;i.keys={};i.keys.all=function(){return"All"};i.keys.raw=function(e){return JSON.stringify(e)};o=function(e){var t=[],r,n=e.dir.major?d3.ascending:d3.descending,o=e.dir.minor?d3.ascending:d3.descending,a=function(e){return e.id},d,s,l,c=[];r=e.docs.map(function(t,r){return{id:r,major:i.keys[e.major](t),minor:i.keys[e.minor](t)}}).sort(function(e,t){return n(e.major,t.major)||o(e.minor,t.minor)||d3.ascending(e.id,t.id)});for(s=0,d="";s<r.length;s+=1){if(r[s].major!==d){c.push(s);t.push({heading:r[s].major});d=r[s].major}}c.shift();c.push(r.length);for(s=0,l=0;s<c.length;s+=1){t[s].docs=r.slice(l,c[s]).map(a);l=c[s]}if(typeof i.keys[e.major].display_heading==="function"){t.forEach(function(t){t.heading_display=i.keys[e.major].display_heading(t.heading)})}return t};i.sort=o;o.validate=function(e){var i=t.sorting.map(function(e){return e[0].split("_")[0]}),r=t.sorting.map(function(e){return e[0].split("_")[1]}),n=e;if(i.indexOf(e.major)===-1){n.major=undefined}if(r.indexOf(e.minor)===-1){n.minor=undefined}if(e.dir!=="up"&&e.dir!=="down"){n.dir=undefined}return n};o.dir=function(e){return{major:e.dir!=="down",minor:true}};a=function(e){return JSON.stringify(e)};i.citation=a;d=function(){return""};i.url=d;return i};"use strict";bib.dfr=function(e){var t=bib(e),i;t.sorting([["year_authortitle","by year, then by author"],["issue_journalcontents","by journal issue"],["year_journalcontents","by year, then by journal contents"],["decade_date","chronologically by decades"],["decade_authortitle","by decades, then by author"],["author_authortitle","alphabetically by author"]]);t.keys.author=function(e){return i(e.authors).replace(/^\W*/,"")[0].toUpperCase()};t.keys.authortitle=function(e){var t=i(e.authors)+e.title;return t.toLowerCase()};t.keys.decade=function(e){return Math.floor(e.date.getUTCFullYear()/10).toString()+"0s"};t.keys.year=function(e){return e.date.getUTCFullYear()};t.keys.journal=function(e){return e.journaltitle};t.keys.issue=function(e){var t=e.journaltitle;t+="_"+d3.format("05d")(e.volume);if(e.issue){t+="_"+e.issue}return t};t.keys.issue.display_heading=function(e){var t,i;t=e.split("_");i=t[0]+" "+String(+t[1]);if(t.length>2){i+="."+t[2]}return i};t.keys.date=function(e){return+e.date};t.keys.journalcontents=function(e){var t=e.journaltitle;t+=d3.format("05d")(e.volume);t+=d3.format("05d")(e.issue===""?0:e.issue.replace(/\/.*$/,""));if(e.pagerange.search(/^\d/)!==-1){t+=d3.format("05d")(e.pagerange.match(/^(\d+)/)[1])}else{t+=e.pagerange}return t};t.sort.dir=function(e){var t={major:true,minor:true};if(e.dir==="up"){return t}if(e.dir==="down"){t.major=false;if(e.major==="decade"||e.major==="year"||e.major==="issue"){t.minor=e.minor!=="date"&&e.minor!=="journal"}else if(e.major==="alpha"||e.major==="journal"){t.minor=e.minor!=="alpha"}else{t.minor=true}}return t};i=function(e){var i,r,n,o=e.split(t.options().author_delimiter).filter(function(e){return/\S/.test(e)}),a=o.length;if(a===0){return t.options().anon}i=o[0].replace(/,/g,"").split(" ");r=i.pop();if(i.length>=2&&r.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){n=i.pop().replace(/_$/,"");r=", "+r.replace(/\W*$/,"")}else{n=r;r=""}n+=", "+i.join(" ")+r;if(a>1){if(a>=t.options().et_al){n+=", ";n+=o.slice(1,t.options().et_al).join(", ");n+="et al."}else{if(a>2){n+=", "}n+=o.slice(1,a-1).join(", ");n+=", and "+o[a-1]}}return n};t.doc_author=i;t.citation=function(e){var t=i(e.authors),r;t=t.replace(/\.?$/,". ");r=e.title.replace(/“/g,"‘").replace(/”/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1‘").replace(/"/g,"’").replace(/'/g,"’").replace(/ <br><\/br>/g,". ");t+="“"+r+".”";t=t.replace(/’\./g,".’");t+=" <em>"+e.journaltitle+"</em> ";t+=e.volume;if(e.issue){t+=", no. "+e.issue}t+=" ("+d3.time.format.utc("%B %Y")(e.date)+"): ";t+=e.pagerange+".";t=t.replace(/\.\./g,".");t=t.replace(/_/g,",");t=t.replace(/\t/g,"");return t};t.url=function(e){return"http://www.jstor.org"+"/stable/"+e.doi};return t};"use strict";var metadata=function(e){var t=e||{},i={},r,n,o;r=function(e){if(typeof e!=="string"){return}t.docs=d3.csv.parse(e)};i.from_string=r;n=function(e){if(isFinite(e)){return t.docs[e]}if(e===undefined){return t.docs}return e.map(function(e){return t.docs[e]})};i.doc=n;o=function(){if(t.docs){return t.docs.length}};i.n_docs=o;return i};metadata.dfr=function(e){var t=e||{},i,r;i=metadata(t);r=function(e){var i;if(typeof e!=="string"){return}i=e.replace(/^\n*/,"").replace(/\n*$/,"\n");t.docs=d3.csv.parseRows(i,function(e,t){var i;i={doi:e[0].trim(),title:e[1].trim(),authors:e[2].trim(),journaltitle:e[3].trim(),volume:e[4].trim(),issue:e[5].trim(),date:new Date(e[6].trim()),pagerange:e[7].trim().replace(/^p?p\. /,"").replace(/-/g,"–")};return i})};i.from_string=r;return i};"use strict";var model;model=function(e){var t=e||{},i={},r,n,o,a,d,s,l,c,u,f,p,w,_,m,v,h,y,g,b,S,I,V,x,k,A;t.ready={};t.worker=new Worker("js/worker.min.js");t.worker.fs=d3.map();t.worker.onmessage=function(e){var i=t.worker.fs.get(e.data.what);if(i){i(e.data.result)}};t.worker.callback=function(e,i){t.worker.fs.set(e,i)};r=function(e){if(e){t.info=e}return t.info};i.info=r;n=function(){var e;if(t.n_docs!==undefined){e=t.n_docs}else if(t.meta){e=t.meta.n_docs()}return e};i.n_docs=n;o=function(){return!!t.ready.dt};i.has_dt=o;a=function(e,i){if(!t.tw){return undefined}if(e===undefined){return t.tw}if(i===undefined){return t.tw[e]}return t.tw[e].get(i)};i.tw=a;d=function(){return t.n};i.n=d;s=function(){if(!this.tw()){return undefined}return t.tw[0].keys().length};i.n_top_words=s;l=function(e){if(!t.total_tokens){t.worker.callback("total_tokens",function(i){t.total_tokens=i;e(i)});t.worker.postMessage({what:"total_tokens"})}else{e(t.total_tokens)}};i.total_tokens=l;c=function(e,i){var r=isFinite(e)?e:"all";t.worker.callback("topic_total/"+r,i);t.worker.postMessage({what:"topic_total",t:r})};i.topic_total=c;u=function(e){if(!t.alpha){return undefined}return isFinite(e)?t.alpha[e]:t.alpha};i.alpha=u;f=function(e){if(!t.meta){return undefined}return t.meta.doc(e)};i.meta=f;m=function(e){if(!t.years){return undefined}return t.years.has(e)};i.valid_year=m;p=function(e){var t=d3.set(),r;if(!a()){return undefined}if(isFinite(e)){a(e).keys().forEach(t.add)}else{if(e===undefined){r=a()}else{r=e.map(function(e){return i.tw(e)})}r.forEach(function(e){e.keys().forEach(function(e){t.add(e)})})}return t.values().sort()};i.vocab=p;w=function(e){if(!t.topic_scaled){return undefined}if(e===undefined){return t.topic_scaled}return t.topic_scaled[e]};i.topic_scaled=w;v=function(e,i){var r=e===undefined?"all":e,n=i;if(r==="all"){n=function(e){i(d3.map(e))}}t.worker.callback("yearly_total/"+r,n);t.worker.postMessage({what:"yearly_total",y:r})};i.yearly_total=v;_=function(e,i){var r=e===undefined?"all":e,n;if(r==="all"){n=function(e){i(e.map(d3.map))}}else{n=function(e){i(d3.map(e))}}t.worker.callback("topic_yearly/"+r,n);t.worker.postMessage({what:"topic_yearly",t:r})};i.topic_yearly=_;h=function(e,r,n,o){var a=r,d=o;if(n!==undefined){a=this.n_docs();d=function(e){var t=e.filter(function(e){return i.meta(e.doc).date.getUTCFullYear()===+n});return o(utils.shorten(t,r))}}t.worker.callback("topic_docs/"+e+"/"+a,d);t.worker.postMessage({what:"topic_docs",t:e,n:a})};i.topic_docs=h;g=function(e,i,r){t.worker.callback("doc_topics/"+e+"/"+i,r);t.worker.postMessage({what:"doc_topics",d:e,n:i})};i.doc_topics=g;y=function(e,t){var r=t||this.n_top_words(),n;if(e===undefined){return d3.range(this.n()).map(function(e){return i.topic_words(e,t)})}n=this.tw(e).entries();n.sort(function(e,t){return d3.descending(e.value,t.value)||d3.ascending(e.key,t.key)});return utils.shorten(n,r,function(e,t){return e[t].value}).map(function(e){return{word:e.key,weight:e.value}})};i.topic_words=y;b=function(e,t){var i,r,n,o=t||this.n_top_words(),a=[],d=function(e){return e.values().reduce(function(e,t){return t>n?e+1:e},0)};for(i=0;i<this.n();i+=1){r=this.tw(i);if(r.has(e)){n=r.get(e);a.push({topic:i,rank:d(r)})}}a.sort(function(e,t){return d3.ascending(e.rank,t.rank)||d3.ascending(e.topic,t.topic)});return utils.shorten(a,o,function(e,t){return e[t].rank})};i.word_topics=b;S=function(e,t){var i,r,n=[];for(i=0;i<this.n();i+=1){r=this.topic_yearly(i);n.push({topic:i,weight:r.get(e)||0})}n.sort(function(e,t){return d3.descending(e.weight,t.weight)||d3.ascending(e.topic,t.topic)});return utils.shorten(n,t)};i.year_topics=S;I=function(e){var i=String(e+1);if(t.info.topic_labels&&t.info.topic_labels[i]){return t.info.topic_labels[i]}return"Topic"+" "+i};i.topic_label=I;x=function(e){var i;if(typeof e!=="string"){return}i=JSON.parse(e);t.alpha=i.alpha;t.tw=i.tw.map(function(e){var t=d3.map();e.words.map(function(i,r){t.set(i,e.weights[r])});return t});if(!t.n){t.n=t.alpha.length}};i.set_tw=x;V=function(e,i){if(typeof e!=="string"){i(false)}t.worker.callback("set_dt",function(e){t.ready.dt=e;i(e)});t.worker.postMessage({what:"set_dt",dt:JSON.parse(e)})};i.set_dt=V;k=function(e){var i;t.meta=e;i=e.doc().map(function(e){return e.date.getUTCFullYear()});t.worker.callback("set_doc_years",function(e){t.ready.doc_years=e});t.worker.postMessage({what:"set_doc_years",doc_years:i});t.years=d3.set(i)};i.set_meta=k;A=function(e){var i;if(typeof e!=="string"){return}i=e.replace(/^\n*/,"").replace(/\n*$/,"\n");t.topic_scaled=d3.csv.parseRows(i,function(e){return e.map(parseFloat)})};i.set_topic_scaled=A;return i};"use strict";view.about=function(e){if(!VIS.ready.about){if(e.meta_info){d3.select("div#meta_info").html(e.meta_info)}VIS.ready.about=true}return true};"use strict";view.bib=function(e){var t=e.ordering.map(function(t){var i=t;t.key=t.heading+"_"+e.minor+"_"+e.dir;return i}),i;d3.selectAll("select#select_bib_sort option").each(function(){this.selected=this.value===e.major+"_"+e.minor});d3.selectAll("select#select_bib_dir option").each(function(){this.selected=this.value===e.dir});d3.select("select#select_bib_sort").on("change",function(){var e;d3.selectAll("#select_bib_sort option").each(function(){if(this.selected){e=this.value}});view.dfb().set_view("/bib/"+e.replace(/_/,"/"))});d3.select("select#select_bib_dir").on("change",function(){var t;d3.selectAll("#select_bib_dir option").each(function(){if(this.selected){t=this.value}});view.dfb().set_view("/bib/"+e.major+"/"+e.minor+"/"+t)});d3.select("a#bib_sort_dir").attr("href","#/bib/"+e.major+"/"+e.minor+"/"+(e.dir==="up"?"down":"up"));d3.select("#bib_headings a.top_link").on("click",function(){d3.event.preventDefault();view.scroll_top()});i=d3.select("#bib_view #bib_headings ul").selectAll("li").data(t,function(e){return e.key});i.enter().append("li").append("a");i.exit().remove();view.bib.major_keys.forEach(function(t){i.classed(t,e.major===t)});i.selectAll("a").attr("href",function(e){return"#"+view.bib.id(e.heading)}).on("click",function(e){d3.event.preventDefault();d3.select("#"+view.bib.id(e.heading)).node().scrollIntoView()}).text(function(e){return e.heading_display||e.heading});view.bib.render({ordering:t,citations:e.citations,major:e.major});return true};view.bib.render=function(e){var t,i,r;view.loading(true);t=d3.select("#bib_main").selectAll("div.section").data(e.ordering,function(e){return e.key});i=t.enter().append("div").classed("section",true).attr("id",function(e){return view.bib.id(e.heading)});i.append("h2").text(function(e){return e.heading_display||e.heading});i.append("ul");t.exit().remove();r=t.select("ul").selectAll("li").data(function(e){return e.docs});r.enter().append("li");r.exit().remove();r.html(function(t){var i='<a href="#/doc/'+t+'">';i+=e.citations[t];i+="</a>";return i});view.loading("false")};view.bib.id=function(e){return"bib_"+String(e).replace(/\W/g,"_")};view.bib.dropdown=function(e){var t=d3.select("select#select_bib_sort").selectAll("option").data(e);t.enter().append("option");t.exit().remove();t.attr("id",function(e){return"sort_"+e[0]}).property("value",function(e){return e[0]}).text(function(e){return e[1]});view.bib.major_keys=d3.set(e.map(function(e){return e[0].split("_")[0]}))};"use strict";view.doc=function(e){var t=d3.select("div#doc_view"),i=e.total_tokens,r=e.topics,n,o;d3.select("#doc_view_main").classed("hidden",false);t.select("h2#doc_header").html(e.citation);t.select("#doc_remark .token_count").text(e.total_tokens);t.select("#doc_remark a.url").attr("href",e.url);n=t.select("table#doc_topics tbody").selectAll("tr").data(r);n.enter().append("tr");n.exit().remove();n.selectAll("td").remove();o=n.append("td").append("a").attr("href",function(e){return view.topic.link(e.topic)}).classed("topic_words",true);o.append("span").classed("name",true).text(function(t,i){return e.labels[i]});n.append("td").append("a").attr("href",function(e){return view.topic.link(e.topic)}).append("span").classed("words",true).text(function(t,i){return e.words[i].reduce(function(e,t){return e+" "+t.word},"")});n.on("click",function(e){view.dfb().set_view(view.topic.hash(e.topic))});view.append_weight_tds(n,function(e){return e.weight/i});n.append("td").classed("td-right",true).text(function(e){return VIS.percent_format(e.weight/i)});n.append("td").classed("td-right",true).text(function(e){return e.weight})};"use strict";view.model=function(){return true};"use strict";view.model.list=function(e){var t,i,r,n=d3.sum(e.sums),o,a,d,s,l=e.yearly[0].keys();t=d3.select("#model_view_list table tbody").selectAll("tr");if(!VIS.ready.model_list){d3.select("th#model_view_list_year a").text(d3.min(l)+"—"+d3.max(l));t=t.data(d3.range(e.yearly.length)).enter().append("tr");t.on("click",function(e){view.dfb().set_view(view.topic.hash(e))});t.classed("hidden_topic",function(t){return e.topic_hidden[t]});t.append("td").append("a").classed("topic_name",true).attr("href",view.topic.link).text(function(t){return e.labels[t]});i=t.append("td").append("div").classed("spark",true);view.append_svg(i,VIS.model_view.list.spark).each(function(t){view.topic.yearly_barplot({svg:d3.select(this),t:t,yearly:e.yearly[t],axes:false,clickable:false,spec:VIS.model_view.list.spark})});t.append("td").append("a").classed("topic_words",true).attr("href",view.topic.link);r=d3.max(e.sums);view.append_weight_tds(t,function(t){return e.sums[t]/r});t.append("td").text(function(t){return VIS.percent_format(e.sums[t]/n)});VIS.ready.model_list=true}t.selectAll("td a.topic_words").text(function(t){return e.words[t].reduce(function(e,t){return e+" "+t.word},"")});if(!VIS.last.model_list){VIS.last.model_list={}}d=e.sort||VIS.last.model_list.sort||"topic";s=e.dir||(d===VIS.last.model_list.sort?VIS.last.model_list.dir:"up")||"up";if(d==="words"){o=e.words.map(function(e){return e.reduce(function(e,t){return e+" "+t.word},"")})}else if(d==="frac"){o=e.sums.map(function(e){return-e/n})}else if(d==="year"){o=e.yearly.map(function(e){var t,i=0;e.forEach(function(e,r){if(r>i){t=e;i=r}});return t})}else{o=e.labels.map(view.topic.sort_name)}if(s==="down"){a=function(e,t){return d3.descending(o[e],o[t])||d3.descending(e,t)}}else{a=function(e,t){return d3.ascending(o[e],o[t])||d3.ascending(e,t)}}VIS.last.model_list.sort=d;VIS.last.model_list.dir=s;t.sort(a).order();d3.selectAll("#model_view_list th.sort").classed("active",function(){return!!this.id.match(d)}).each(function(){var e="#/"+this.id.replace(/_(view_)?/g,"/");if(this.id.match(d)){e+=s==="down"?"/up":"/down"}d3.select(this).select("a").attr("href",e)}).on("click",function(){view.dfb().set_view(d3.select(this).select("a").attr("href").replace(/#/,""))});return true};"use strict";view.model.plot=function(e){var t,i,r,n,o,a,d,s,l,c,u,f,p,w,_,m,v=e.topics,h=e.topics.length,y={};y.w=d3.select("#model_view").node().clientWidth||VIS.model_view.w;y.w=Math.max(y.w,VIS.model_view.w);y.h=Math.floor(y.w/VIS.model_view.aspect);y.m={left:0,right:0,top:0,bottom:0};t=view.plot_svg("#model_view_plot",y);r=Math.floor(y.w/(2.1*Math.sqrt(VIS.model_view.aspect*h)));i=r*1.8;n=1.1*r;o=t.selectAll("rect.bg").data([1]);o.enter().append("rect").classed("bg",true);o.attr("width",y.w);o.attr("height",y.h);if(e.type==="scaled"){v.forEach(function(e,t){v[t].x=e.scaled[0];v[t].y=e.scaled[1]})}else{v.forEach(function(e,t){v[t].sort_key=view.topic.sort_name(e.label)});v=v.sort(function(e,t){return d3.ascending(e.sort_key,t.sort_key)});view.model.grid_coords(h,VIS.model_view.cols||Math.floor(Math.sqrt(VIS.model_view.aspect*h))).forEach(function(e,t){v[t].x=e.x;v[t].y=e.y})}a=d3.extent(v,function(e){return e.x});d=d3.extent(v,function(e){return e.y});s=d3.scale.linear().domain(a).range([n,y.w-n]);l=d3.scale.linear().domain(d).range([y.h-n,n]);c=d3.scale.sqrt().domain([0,1]).range(VIS.model_view.size_range);u=d3.scale.linear().domain([0,d3.max(v,function(e){return e.total})]).range([0,VIS.model_view.stroke_range]);f=t.selectAll("g").data(v,function(e){return e.t});p=f.enter().append("g");f.exit().remove();p.append("clipPath").attr("id",function(e){return"clip_circ"+e.t}).append("circle").attr({cx:0,cy:0});p.append("circle").attr("cx",0).attr("cy",0).classed("topic_cloud",true).attr("stroke-width",function(e){return u(e.total)}).on("click",function(e){if(!d3.event.shiftKey){view.dfb().set_view(view.topic.hash(e.t))}}).on("mouseover",function(e){f.sort(function(t,i){if(t.t===i.t){return 0}if(t.t===e.t){return 1}if(i.t===e.t){return-1}return d3.ascending(t.t,i.t)}).order()}).on("mouseout",function(){f.sort(function(e,t){return d3.ascending(e.t,t.t)}).order()});w=f.selectAll("text.topic_word").data(function(e){var t=e.words[0].weight,r=e.words.map(function(i){return{text:i.word,size:Math.floor(c(i.weight/t)),t:e.t}}),n=0,o=0,a=false,d;for(d=0;d<r.length;d+=1,a=!a){if(a){r[d].y=n;n-=r[d].size}else{o+=r[d].size;r[d].y=o}if(n-i/2<r[d].size&&o>i/2){break}}return r.slice(0,d)});w.enter().append("text").classed("topic_word",true).attr("clip-path",function(e){return"url(#"+"clip_circ"+e.t}).style("font-size","1px");w.text(function(e){return e.text}).attr("x",0).attr("y",function(e){return e.y});p.selectAll("text.topic_name").data(function(e){var t=e.label.split(" ");return t.map(function(e,i){return{w:e,y:VIS.model_view.name_size*(i-(t.length-1)/2)}})}).enter().append("text").classed("topic_name",true).attr("x",0).attr("y",function(e){return e.y}).text(function(e){return e.w}).style("font-size",VIS.model_view.name_size+"px").classed("merged_topic_sep",function(e){return e.w==="or"});_=function(e){var t="translate("+s(e.x);t+=","+l(e.y)+")";return t};f.transition().duration(1e3).attr("transform",_).selectAll("circle").attr("r",r);p.transition().duration(0).attr("transform",_).selectAll("circle").attr("r",r);w.transition().duration(1e3).style("font-size",function(e){return e.size+"px"});p.selectAll("text.topic_word").transition().duration(0).style("font-size",function(e){return e.size+"px"});w.exit().transition().duration(1e3).style("font-size","1px").remove();if(e.type==="scaled"){m=d3.behavior.zoom().x(s).y(l).scaleExtent([1,10]).on("zoom",function(){if(VIS.zoom_transition){f.transition().duration(1e3).attr("transform",_);VIS.zoom_transition=false}else{f.attr("transform",_)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;m.translate([0,0]).scale(1).event(t)});m(t)}else{t.on(".zoom",null)}};view.model.grid_coords=function(e,t){var i=t||Math.floor(Math.sqrt(e)),r=Math.round(e/i),n=e-r*i,o=d3.ascending(n,0),a=[],d,s,l,c=[];d=Math.sqrt(3)/2;for(s=o===1?0:1;s<r;s+=2){a[s]=i;if(Math.abs(n)>0){a[s]+=o;n-=o}}for(s=o===1?1:0;s<r;s+=2){a[s]=i;if(Math.abs(n)>0){a[s]+=o;n-=o}}if(o===-1){a.reverse()}if(d3.sum(a)!==e){view.error("The topic grid has gone wrong. This is a bug.")}for(s=0;s<r;s+=1){for(l=0;l<a[s];l+=1){c.push({x:l+.5+(s%2===0?0:.5),y:(r-s)*d+.5})}}return c};"use strict";view.model.yearly=function(e){var t={},i,r,n,o,a,d,s,l,c,u,f,p,w,_,m,v;t.m=VIS.model_view.yearly.m;t.w=d3.select("#model_view_yearly").node().clientWidth||VIS.model_view.yearly.w;t.w=Math.max(t.w,VIS.model_view.yearly.w);t.w-=t.m.left+t.m.right;t.h=Math.floor(t.w/VIS.model_view.yearly.aspect);t.h-=t.m.top+t.m.bottom;i=view.plot_svg("#model_view_yearly",t);u=e.type?e.type==="raw":VIS.last.model_yearly;VIS.last.model_yearly=u;f=view.model.yearly.stacked_series({yearly_totals:e.yearly_totals,topics:e.topics,raw:u});l=i.selectAll("rect.bg").data([1]).enter().append("rect").classed("bg",true);l.attr("width",t.w).attr("height",t.h).classed("bg",true);c=d3.select("#model_yearly_clip");if(c.size()===0){c=d3.select("#model_view_yearly svg").append("clipPath").attr("id","model_yearly_clip");c.append("rect").attr("x",0).attr("y",0).attr("width",t.w).attr("height",t.h)}d3.select("#model_yearly_clip rect").transition().duration(2e3).attr("width",t.w).attr("height",t.h);s=function(){var e=d3.scale.category20(),t=[];f.order.forEach(function(e,i){t[e]=i});return function(i,r){var n=e(t[i]%20);return r?d3.hsl(n).brighter(.5).toString():n}}();r=d3.time.scale.utc().domain(f.domain_x).range([0,t.w]);n=d3.scale.linear().domain(f.domain_y).range([t.h,0]).nice();o=d3.svg.axis().scale(r).orient("bottom");a=i.selectAll("g.axis").data([1]);a.enter().append("g").classed("axis",true).classed("x",true).attr("transform","translate(0,"+t.h+")");a.transition().duration(2e3).attr("transform","translate(0,"+t.h+")").call(o);p=i.selectAll("path.topic_area").data(f.data);p.enter().append("path").classed("topic_area",true).attr("clip-path","url(#model_yearly_clip)").style("fill",function(e){return s(e.t)}).on("mouseover",function(e){var t=e.label;d3.select(this).style("fill",s(e.t,true));if(VIS.model_view.yearly.words>0){t+=": ";t+=e.words.join(" ")}view.tooltip().text(t);view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this).style("fill",s(e.t));view.tooltip().hide()}).on("click",function(e){if(!d3.event.shiftKey){view.dfb().set_view(view.topic.hash(e.t))}});p.exit().remove();d=d3.svg.area().x(function(e){return r(e.x)}).y0(function(e){return n(e.y0)}).y1(function(e){return n(e.y0+e.y)});m=function(e){return d(e.values)};p.transition().duration(2e3).attr("d",m);w=i.selectAll("text.layer_label").data(f.data,function(e){return e.t});w.enter().append("text").classed("layer_label",true).attr("clip-path","url(#model_yearly_clip)");w.exit().remove();_=function(e){var t,i,o,a,d,s=[],l=[],c=r.domain()[0],u=r.domain()[1],p=n.domain()[0],w=n.domain()[1],_=n(0);for(t=0;t<f.data.length;t+=1){o=f.data[t].t;s[o]=false;a=f.data[t].values;for(i=0,d=0;i<a.length;i+=1){if(a[i].x>=c&&a[i].x<=u&&a[i].y0+a[i].y>=p&&a[i].y0+a[i].y<=w){if(a[i].y>d&&_-n(a[i].y)>VIS.model_view.yearly.label_threshold){s[o]=true;l[o]=i;d=a[i].y}}}}e.attr("display",function(e){return s[e.t]?"inherit":"none"});e.filter(function(e){return s[e.t]}).attr("x",function(e){return r(e.values[l[e.t]].x)}).attr("y",function(e){return n(e.values[l[e.t]].y0+e.values[l[e.t]].y/2)}).text(function(e){var t=e.label;if(VIS.model_view.yearly.label_words>0){t+=": ";t+=e.words.slice(0,VIS.model_view.yearly.label_words).join(" ")}return t})};_(w.transition().duration(2e3));v=d3.behavior.zoom().x(r).y(n).scaleExtent([1,5]).on("zoom",function(){if(VIS.zoom_transition){p.transition().duration(2e3).attr("d",m);i.select("g.x.axis").transition().duration(2e3).call(o);_(w.transition().duration(2e3));VIS.zoom_transition=false}else{p.attr("d",m);_(w);i.select("g.x.axis").call(o)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;v.translate([0,0]).scale(1).event(i)});v(i);d3.select("button#yearly_raw_toggle").text(u?"Show proportions":"Show counts").on("click",function(){view.dfb().set_view(u?"/model/yearly/frac":"/model/yearly/raw")});d3.selectAll("#yearly_choice li").classed("active",false);d3.select(u?"#nav_model_yearly_raw":"#nav_model_yearly_frac").classed("active",true);return true};view.model.yearly.stacked_series=function(e){var t,i,r,n,o,a,d,s;if(!VIS.model_view.yearly.data){VIS.model_view.yearly.data={};t=e.yearly_totals.keys().sort();i=t.map(function(e){return new Date(Date.UTC(+e,0,1))});VIS.model_view.yearly.domain_years=d3.extent(i);r=e.topics.map(function(e){var r={t:e.t,words:e.words.map(function(e){return e.word}),label:e.label};r.values=t.map(function(t,r){var n={yr:t,x:i[r],y:e.wts.get(t)||0};return n});return r});n=d3.layout.stack().values(function(e){return e.values}).offset("wiggle").order("inside-out");a=n(r);o=n.order()(r.map(function(e){return e.values.map(function(e){return[e.x,e.y]})}));n.order(function(e){return o});d=n(r.map(function(t){return{t:t.t,words:t.words,label:t.label,values:t.values.map(function(t){return{x:t.x,y:t.y*e.yearly_totals.get(t.yr)}})}}));s=function(e){return[0,d3.max(e.map(function(e){return d3.max(e.values,function(e){return e.y0+e.y})}))]};VIS.model_view.yearly.domain_frac=s(a);VIS.model_view.yearly.domain_raw=s(d);VIS.model_view.yearly.order=o;VIS.model_view.yearly.data.frac=a;VIS.model_view.yearly.data.raw=d}return{data:VIS.model_view.yearly.data[e.raw?"raw":"frac"],domain_x:VIS.model_view.yearly.domain_years,domain_y:VIS.model_view.yearly[e.raw?"domain_raw":"domain_frac"],order:VIS.model_view.yearly.order}};"use strict";view.settings=function(e){if(VIS.ready.settings){return}d3.select("#n_words_list input").property("min",1).property("max",e.max_words).property("value",VIS.overview_words).on("change",function(){VIS.overview_words=this.valueAsNumber});d3.select("#n_words_topic input").property("min",1).property("max",e.max_words).property("value",VIS.topic_view.words).on("change",function(){VIS.topic_view.words=this.valueAsNumber;view.dirty("topic/words",true)});d3.select("#n_topic_docs input").property("min",1).property("max",e.max_docs).property("value",VIS.topic_view.docs).on("change",function(){VIS.topic_view.docs=this.valueAsNumber;view.dirty("topic/docs",true)});d3.select("#reveal_hidden").classed("hidden",VIS.hidden_topics.length===0).select("input").property("checked",VIS.show_hidden_topics===true).on("change",function(){VIS.show_hidden_topics=!VIS.show_hidden_topics;VIS.model_view.yearly.data=undefined;VIS.ready.model_yearly=false});VIS.ready.settings=true};"use strict";view.topic=function(e){var t=d3.select("div#topic_view");t.select("#topic_header").text(e.label)};view.topic.remark=function(e){d3.select("#topic_view #topic_remark").text(VIS.percent_format(e.col_sum/e.total_tokens)+" of corpus")};view.topic.words=function(e){var t;if(view.updating()&&!view.dirty("topic/words")){return}t=d3.select("table#topic_words tbody").selectAll("tr").data(e);t.enter().append("tr");t.exit().remove();t.on("click",function(e){view.dfb().set_view("/word/"+e.word)});t.selectAll("td").remove();t.append("td").append("a").attr("href",function(e){return"#/word/"+e.word}).text(function(e){return e.word});view.append_weight_tds(t,function(t){return t.weight/e[0].weight});view.dirty("topic/words",false)};view.topic.docs=function(e){var t,i,r=e.docs;if(e.year!==undefined){t=" in "+e.year;d3.select("#topic_year_clear").classed("disabled",false).on("click",function(){d3.select(".selected_year").classed("selected_year",false);view.updating(true);view.dfb().set_view(view.topic.hash(e.t))}).classed("hidden",false)}else{t="";d3.select("#topic_year_clear").classed("disabled",true)}d3.selectAll("#topic_docs span.topic_year").text(t);if(r===undefined||r.length===0){d3.selectAll("#topic_docs .none").classed("hidden",false);d3.select("#topic_docs table").classed("hidden",true);return true}d3.selectAll("#topic_docs .none").classed("hidden",true);d3.select("#topic_docs table").classed("hidden",false);i=d3.select("#topic_docs tbody").selectAll("tr").data(r);i.enter().append("tr");i.exit().remove();i.selectAll("td").remove();i.append("td").append("a").html(function(t,i){return e.citations[i]});i.on("click",function(e){view.dfb().set_view("/doc/"+e.doc)});view.append_weight_tds(i,function(e){return e.frac});i.append("td").classed("td-right",true).text(function(e){return VIS.percent_format(e.frac)});i.append("td").classed("td-right",true).text(function(e){return e.weight});view.dirty("topic/docs",false)};view.topic.yearly=function(e){var t=VIS.topic_view;t.w=d3.select("#topic_yearly").node().clientWidth||t.w;t.w=Math.max(t.w,VIS.topic_view.w);t.w-=t.m.left+t.m.right;t.h=Math.floor(t.w/VIS.topic_view.aspect)-t.m.top-t.m.bottom;view.topic.yearly_barplot({t:e.t,yearly:e.yearly,svg:view.plot_svg("div#topic_plot",t),axes:true,clickable:true,year:e.year,spec:t})};view.topic.yearly_barplot=function(e){var t=[],i,r,n,o,a,d,s,l,c,u=view.dirty("topic/yearly")?1e3:0,f=e.svg,p=e.spec;t=e.yearly.keys().sort().map(function(t){
return[new Date(Date.UTC(+t,0,1)),e.yearly.get(t)]});i=d3.time.scale.utc().domain([t[0][0],d3.time.day.utc.offset(t[t.length-1][0],p.bar_width)]).range([0,p.w]);n=i(d3.time.day.utc.offset(t[0][0],p.bar_width))-i(t[0][0]);o=i(d3.time.year.utc.offset(t[0][0],1))-i(t[0][0]);r=d3.scale.linear().domain([0,d3.max(t,function(e){return e[1]})]).range([p.h,0]).nice();if(e.axes){l=f.selectAll("g.axis").data(["x","y"]);l.enter().append("g").classed("axis",true).classed("x",function(e){return e==="x"}).classed("y",function(e){return e==="y"}).attr("transform",function(e){return e==="x"?"translate(0,"+p.h+")":"translate(-5, 0)"});l.transition().duration(u).attr("transform",function(e){return e==="x"?"translate(0,"+p.h+")":undefined}).each(function(e){var t=d3.select(this),n=d3.svg.axis().scale(e==="x"?i:r).orient(e==="x"?"bottom":"left");if(e==="x"){n=n.ticks(d3.time.years.utc,p.ticks)}else{n=n.tickSize(-p.w).outerTickSize(0).tickFormat(VIS.percent_format).tickPadding(o/2).ticks(p.ticks)}t.call(n);if(e==="y"){t.selectAll("g").filter(function(e){return e>0}).classed("minor",true)}})}a=f.selectAll("g.topic_proportion").data(t,function(e){return String(e[0].getUTCFullYear())});d=a.enter().append("g").classed("topic_proportion",true).attr("transform",function(e){return"translate("+i(e[0])+",0)"});a.exit().remove();if(e.clickable){d.append("rect").classed("interact",true);s=a.select("rect.interact");s.transition().duration(u).attr("x",-o/2).attr("y",0).attr("width",o).attr("height",function(e){return p.h})}a.classed("selected_year",function(t){return String(t[0].getUTCFullYear())===e.year});d.append("rect").classed("display",true).style("fill",e.color).style("stroke",e.color);a.transition().duration(u).attr("transform",function(e){return"translate("+i(e[0])+",0)"}).select("rect.display").attr("x",-n/2).attr("y",function(e){return r(e[1])}).attr("width",n).attr("height",function(e){return p.h-r(e[1])});if(e.clickable){a.on("mouseover",function(e){d3.select(this).classed("hover",true)}).on("mouseout",function(e){d3.select(this).classed("hover",false)});c=function(e){return e[0].getUTCFullYear()};s.on("mouseover",function(e){var t=d3.select(this.parentNode);t.select(".display").classed("hover",true);view.tooltip().text(c(e));view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this.parentNode).select(".display").classed("hover",false);view.tooltip().hide()}).on("click",function(t){if(d3.select(this.parentNode).classed("selected_year")){d3.select(this.parentNode).classed("selected_year",false);view.tooltip().text(c(t));view.updating(true);view.dfb().set_view(view.topic.hash(e.t))}else{d3.selectAll(".selected_year").classed("selected_year",false);d3.select(this.parentNode).classed("selected_year",true);view.tooltip().text(c(t));view.updating(true);view.dfb().set_view(view.topic.hash(e.t)+"/"+t[0].getUTCFullYear())}})}view.dirty("topic/yearly",false)};view.topic.sort_name=function(e){var t=e.match(/^Topic\s(\d+)$/);if(t){return"zzz"+d3.format("05d")(+t[1])}return e.replace(/^(the|a|an) /i,"").toLowerCase()};view.topic.dropdown=function(e){var t;d3.select("ul#topic_dropdown").selectAll("li.loading_message").remove();t=d3.select("ul#topic_dropdown").selectAll("li").data(e,function(e){return e.topic});t.enter().append("li").append("a").text(function(e){var t=e.words.slice(0,VIS.overview_words).map(function(e){return e.word}).join(" ");return e.label+": "+t}).attr("href",function(e){return view.topic.link(e.topic)});t.sort(function(e,t){return d3.ascending(view.topic.sort_name(e.label),view.topic.sort_name(t.label))});t.classed("hidden_topic",function(e){return e.hidden})};view.topic.link=function(e){return"#"+view.topic.hash(e)};view.topic.hash=function(e){return"/topic/"+String(e+1)};"use strict";view.word=function(e){var t=d3.select("div#word_view"),i=e.word,r=e.n,n,o,a,d,s,l,c,u,f,p,w,_,m,v,h;d3.select("form#word_view_form").on("submit",function(){d3.event.preventDefault();var e=d3.select("input#word_input").property("value").toLowerCase();view.dfb().set_view("/word/"+e)});if(e.word===undefined){return}t.selectAll("#word_view span.word").text(i);t.selectAll("#word_view .none").classed("hidden",e.topics.length!==0);t.select("table#word_topics").classed("hidden",e.topics.length===0);t.select("#word_view_explainer").classed("hidden",e.topics.length===0);n=e.topics.map(function(t,i){var r,n=e.words[i];return n.map(function(e,t){if(t===0){r=e.weight}return{word:e.word,weight:e.weight/r}})});o={m:VIS.word_view.m};o.w=d3.select("#main_container").node().clientWidth||VIS.word_view.w;o.w-=o.m.left+o.m.right;o.h=VIS.word_view.row_height*(e.topics.length+1);a=VIS.word_view.row_height;s=view.plot_svg("#word_view_main",o);d=Math.max(o.w,VIS.word_view.w);c=d3.scale.linear().domain([0,r]).range([0,d]);u=d3.scale.linear().domain([0,Math.max(1,e.topics.length-1)]).range([a,a*(Math.max(e.topics.length,1)+1)]);f=d3.scale.linear().domain([0,1]).range([0,a/2]);l=d3.select("#word_view_clip");if(l.size()===0){l=d3.select("#word_view svg").append("clipPath").attr("id","word_view_clip");l.append("rect")}l.select("rect").attr("x",-o.m.left).attr("y",-o.m.top).attr("width",o.w+o.m.left+o.m.right).attr("height",o.h+o.m.top+o.m.bottom);s.attr("clip-path","url(#word_view_clip)");p=s.selectAll("g.topic").data(e.topics,function(e){return e.topic});p.transition().duration(1e3).attr("transform",function(e,t){return"translate(0,"+u(t)+")"});w=p.enter().append("g").classed("topic",true).attr("transform",function(e,t){return"translate(0,"+u(t)+")"}).style("opacity",0);if(!VIS.ready.word||view.updating()){d3.selectAll("g.topic").style("opacity",1)}else{d3.transition().duration(1e3).ease("linear").each("end",function(){d3.selectAll("g.topic").style("opacity",1)})}p.exit().transition().duration(2e3).attr("transform","translate(0,"+a*(r+p.exit().size())+")").remove();w.append("rect").classed("interact",true).attr({x:-o.m.left,y:-a,width:o.m.left,height:a}).on("click",function(e){view.dfb().set_view(view.topic.hash(e.topic))});_=p.selectAll("text.topic").data(function(t,i){var r=e.labels[i].split(" ");return r.map(function(e,t){return{word:e,y:-a/2-(r.length/2-t-1)*VIS.word_view.topic_label_leading}})},function(e,t){return e.word+String(t)});_.enter().append("text").classed("topic",true);_.exit().remove();_.attr("x",-VIS.word_view.topic_label_padding).attr("y",function(e){return e.y}).text(function(e){return e.word}).classed("merged_topic_sep",function(e){return e.word==="or"});m=p.selectAll("g.word").data(function(e,t){return n[t]},function(e){return e.word});v=m.enter().append("g").classed("word",true);v.append("text").attr("transform","rotate(-45)");v.append("rect").classed("proportion",true).attr({x:0,y:0}).attr("width",d/(2*r)).attr("height",function(e){return f(e.weight)});m.selectAll("text").text(function(e){return e.word});m.selectAll("text, rect").on("click",function(e){view.dfb().set_view("/word/"+e.word)}).on("mouseover",function(){d3.select(this.parentNode).classed("hover",true)}).on("mouseout",function(){d3.select(this.parentNode).classed("hover",false)});m.classed("selected_word",function(e){return e.word===i});v.attr("transform",function(e,t){return"translate("+c(t)+",-"+a/2+")"}).attr("opacity",VIS.ready.word&&!view.updating()?0:1);h=m.transition().duration(2e3).attr("transform",function(e,t){return"translate("+c(t)+",-"+a/2+")"}).attr("opacity",1);h.selectAll("text").attr("x",d/(4*r));h.selectAll("rect").attr("width",d/(2*r)).attr("height",function(e){return f(e.weight)});m.exit().transition().delay(1e3).remove();VIS.ready.word=true;return true};"use strict";view.words=function(e){var t=d3.select("ul#vocab_list").selectAll("li").data(e);t.exit().remove();t.enter().append("li").append("a");t.select("a").text(function(e){return e}).attr("href",function(e){return"#/word/"+e});return true};"use strict";var dfb=function(e){var t=e||{},i={},r,n,o,a,d,s,l,c,u,f,p,w,_,m,v,h,y;t.m=model();if(e.metadata===undefined){t.metadata=metadata.dfr()}else{t.metadata=e.metadata()}if(typeof e.bib!=="function"){t.bib=bib.dfr()}else{t.bib=e.bib()}if(view.dfb()===undefined){view.dfb(i)}else{view.error("view.dfb already defined: browser() called more than once?")}r=function(e,i){var r,n,o=+e-1;if(!t.m.meta()||!t.m.has_dt()||!t.m.tw()){view.loading(true);return true}if(!isFinite(o)||o<0||o>=t.m.n()){d3.select("#topic_view_help").classed("hidden",false);d3.select("#topic_view_main").classed("hidden",true);view.loading(false);return true}n=t.m.valid_year(i)?i:undefined;r=utils.shorten(t.m.topic_words(o),VIS.topic_view.words);view.topic({t:o,words:r,label:t.m.topic_label(o)});d3.select("#topic_view_help").classed("hidden",true);d3.select("#topic_view_main").classed("hidden",false);t.m.total_tokens(function(e){t.m.topic_total(o,function(i){view.topic.remark({alpha:t.m.alpha(o),col_sum:i,total_tokens:e})})});view.topic.words(r);if(VIS.cur_view&&VIS.cur_view.attr("id")==="topic_view"){view.dirty("topic/yearly",true)}if(!view.updating()&&!view.dirty("topic/yearly")){d3.select("#topic_plot").classed("invisible",true)}t.m.topic_yearly(o,function(e){view.topic.yearly({t:o,year:n,yearly:e});d3.select("#topic_plot").classed("invisible",false)});view.calculating("#topic_docs",true);t.m.topic_docs(o,VIS.topic_view.docs,n,function(e){view.calculating("#topic_docs",false);view.topic.docs({t:o,docs:e,citations:e.map(function(e){return t.bib.citation(t.m.meta(e.doc))}),year:n})});view.loading(false);return true};i.topic_view=r;n=function(e){var i=d3.select("div#word_view"),r=e,n,o=0;if(!t.m.tw()){view.loading(true);return true}view.loading(false);if(r){i.select("#word_view_help").classed("hidden",true)}else{i.select("#word_view_help").classed("hidden",false);if(VIS.last.word){r=VIS.last.word;i.select("a#last_word").attr("href","#/word/"+r).text(document.URL.replace(/#.*$/,"")+"#/word/"+r);i.select("#last_word_help").classed("hidden",false)}else{i.select("#word_view_main").classed("hidden",true);view.word({word:undefined});return true}}i.select("#word_view_main").classed("hidden",false);VIS.last.word=r;n=t.m.word_topics(r).filter(function(e){return!VIS.topic_hidden[e.topic]||VIS.show_hidden_topics});if(n.length>0){o=1+d3.max(n,function(e){return e.rank});o=d3.max(n,function(e){return t.m.topic_words(e.topic,o).length})}o=Math.max(VIS.word_view.n_min,o);view.word({word:r,topics:n,words:n.map(function(e){return t.m.topic_words(e.topic,o).slice(0,o)}),n:o,n_topics:t.m.n(),labels:n.map(function(e){return t.m.topic_label(e.topic)})});return true};i.word_view=n;o=function(){var e;if(!t.m.tw()){view.loading(true);return true}view.loading(false);if(!VIS.show_hidden_topics){e=d3.range(t.m.n()).filter(function(e){return!VIS.topic_hidden[e]})}return view.words(t.m.vocab(e))};i.words_view=o;a=function(e){var i=d3.select("div#doc_view"),r=+e;if(!t.m.meta()||!t.m.has_dt()||!t.m.tw()){view.loading(true);return true}view.loading(false);if(!isFinite(r)||r<0||r>=t.m.n_docs()){d3.select("#doc_view_help").classed("hidden",false);if(VIS.last.doc===undefined){d3.select("#doc_view_main").classed("hidden",true);return true}r=VIS.last.doc;i.select("a#last_doc").attr("href","#/doc/"+r).text(document.URL.replace(/#.*$/,"")+"#/doc/"+r);i.select("#last_doc_help").classed("hidden",false)}else{d3.select("#doc_view_help").classed("hidden",true);VIS.last.doc=r}d3.select("#doc_view_main").classed("hidden",false);view.calculating("#doc_view",true);t.m.doc_topics(r,t.m.n(),function(e){var i=e.filter(function(e){return!VIS.topic_hidden[e.topic]||VIS.show_hidden_topics});view.calculating("#doc_view",false);view.doc({topics:i,citation:t.bib.citation(t.m.meta(r)),url:t.bib.url(t.m.meta(r)),total_tokens:d3.sum(i,function(e){return e.weight}),words:i.map(function(e){return t.m.topic_words(e.topic,VIS.overview_words)}),labels:i.map(function(e){return t.m.topic_label(e.topic)})});m()});return true};i.doc_view=a;d=function(e,i,r){var n={major:e,minor:i,dir:r},o;if(!t.m.meta()){view.loading(true);return true}n=t.bib.sort.validate(n);if(n.minor===undefined){if(n.major===undefined){n.minor=VIS.last.bib.minor||VIS.bib_view.minor}else{n.minor=VIS.bib_view.minor}}if(n.major===undefined){n.major=VIS.last.bib.major||VIS.bib_view.major}if(n.dir===undefined){n.dir=VIS.last.bib.dir||VIS.bib_view.dir}VIS.last.bib=n;n.docs=t.m.meta();o=t.bib.sort({major:n.major,minor:n.minor,dir:t.bib.sort.dir(n),docs:t.m.meta()});if(!VIS.ready.bib){VIS.bib_citations=t.m.meta().map(t.bib.citation);view.bib.dropdown(t.bib.sorting());VIS.ready.bib=true}view.bib({ordering:o,major:n.major,minor:n.minor,dir:n.dir,citations:VIS.bib_citations});view.loading(false);VIS.ready.bib=true;return true};i.bib_view=d;s=function(){view.about(t.m.info());view.loading(false);d3.select("#about_view").classed("hidden",false);return true};i.about_view=s;l=function(){var e={max_words:t.m.n_top_words(),max_docs:t.m.n_docs()};if(e.max_words===undefined||e.max_docs===undefined){return false}view.settings(e);$("#settings_modal").modal();return true};i.settings_modal=l;c=function(e,i,r){var n=e||VIS.last.model||"grid";if(!t.m.tw()||!t.m.topic_scaled()){view.loading(true);return true}d3.selectAll("#nav_model li.active").classed("active",false);d3.select("#nav_model_"+n).classed("active",true);d3.select("#model_view_plot").classed("hidden",true);d3.select("#model_view_list").classed("hidden",true);d3.select("#model_view_yearly").classed("hidden",true);d3.selectAll(".model_view_grid").classed("hidden",true);d3.selectAll(".model_view_scaled").classed("hidden",true);d3.selectAll(".model_view_list").classed("hidden",true);d3.selectAll(".model_view_yearly").classed("hidden",true);d3.select("#model_view nav").classed("hidden",false);if(n==="list"){if(!t.m.meta()||!t.m.has_dt()){view.loading(true);return true}u(i,r);d3.select("#model_view_list").classed("hidden",false)}else if(n==="yearly"){if(!t.m.meta()||!t.m.has_dt()){view.loading(true);return true}p(i);d3.select("#model_view_yearly").classed("hidden",false)}else{if(!t.m.topic_scaled()||!t.m.has_dt()){view.loading(true);return true}if(n!=="scaled"||t.m.topic_scaled().length!==t.m.n()){n="grid"}f(n);d3.select("#model_view_plot").classed("hidden",false)}VIS.last.model=n;d3.selectAll(".model_view_"+n).classed("hidden",false);view.loading(false);return true};i.model_view=c;u=function(e,i){view.calculating("#model_view_list",true);t.m.topic_total(undefined,function(r){t.m.topic_yearly(undefined,function(n){view.calculating("#model_view_list",false);view.model.list({yearly:n,sums:r,words:t.m.topic_words(undefined,VIS.overview_words),sort:e,dir:i,labels:d3.range(t.m.n()).map(t.m.topic_label),topic_hidden:VIS.topic_hidden});m()})});return true};i.model_view_list=u;f=function(e){t.m.topic_total(undefined,function(i){var r=d3.range(t.m.n());if(!VIS.show_hidden_topics){r=r.filter(function(e){return!VIS.topic_hidden[e]})}view.model.plot({type:e,topics:r.map(function(e){return{t:e,words:t.m.topic_words(e,VIS.model_view.words),scaled:t.m.topic_scaled(e),total:i[e],label:t.m.topic_label(e)}})})});return true};i.model_view_plot=f;p=function(e){var i={type:e};if(VIS.ready.model_yearly){view.model.yearly(i);return true}view.calculating("#model_view_yearly",true);t.m.yearly_total(undefined,function(e){t.m.topic_yearly(undefined,function(r){i.yearly_totals=e;i.topics=r.map(function(e,i){return{t:i,wts:e,words:t.m.topic_words(i,VIS.model_view.yearly.words),label:t.m.topic_label(i)}}).filter(function(e){return VIS.show_hidden_topics||!VIS.topic_hidden[e.t]});view.model.yearly(i);view.calculating("#model_view_yearly",false)})});return true};i.model_view_yearly=p;w=function(){var e,t,i,u,f;e=window.location.hash.split("/");if(VIS.cur_view!==undefined&&!view.updating()){VIS.cur_view.classed("hidden",true)}if(e[0]!=="#"){e=VIS.default_view.split("/")}t=e[1];i=e.slice(2,e.length);switch(t){case"model":u=c.apply(undefined,i);break;case"about":u=s.apply(undefined,i);break;case"bib":u=d.apply(undefined,i);break;case"topic":u=r.apply(undefined,i);break;case"word":u=n.apply(undefined,i);break;case"doc":u=a.apply(undefined,i);break;case"words":u=o.apply(undefined,i);break;case"settings":l();u=false;break;default:u=false;break}if(u){if(typeof u==="string"){i=[undefined].concat(u.split("/"))}VIS.cur_view=d3.select("div#"+t+"_view");VIS.annotes.forEach(function(e){d3.selectAll(e).classed("hidden",true)});VIS.annotes=[".view_"+t];for(f=1;f<i.length;f+=1){VIS.annotes[f]=VIS.annotes[f-1]+"_"+i[f]}VIS.annotes.forEach(function(e){d3.selectAll(e).classed("hidden",false)})}else{if(VIS.cur_view===undefined){VIS.cur_view=d3.select("div#model_view");c()}}if(!view.updating()){view.scroll_top()}view.updating(false);m();VIS.cur_view.classed("hidden",false);d3.selectAll("#nav_main > li.active").classed("active",false);d3.select("li#nav_"+t).classed("active",true);d3.selectAll("#nav_main li:not(.active) > .nav").classed("hidden",true);d3.selectAll("#nav_main li.active > .nav").classed("hidden",false)};i.refresh=w;_=function(e){window.location.hash=e};i.set_view=_;m=function(e){var t=e===undefined?!VIS.show_hidden_topics:e;d3.selectAll(".hidden_topic").classed("hidden",function(){return t})};i.hide_topics=m;v=function(){window.onhashchange=function(){w()};$(window).resize(function(){if(VIS.resize_timer){window.clearTimeout(VIS.resize_timer)}VIS.resize_timer=window.setTimeout(function(){view.updating(true);view.dirty("topic/yearly",true);w();VIS.resize_timer=undefined},VIS.resize_refresh_delay)});d3.select("#nav_settings a").on("click",function(){d3.event.preventDefault();l()});$("#settings_modal").on("hide.bs.modal",function(){view.updating(true);w()})};i.setup_listeners=v;h=function(e,t){var i,r;if(e===undefined){return t("target undefined",undefined)}i=e.replace(/^.*\//,"");r=d3.select("#m__DATA__"+i.replace(/\..*$/,""));if(!r.empty()){return t(undefined,JSON.parse(r.html()))}if(e.search(/\.zip$/)>0){return d3.xhr(e).responseType("arraybuffer").get(function(e,r){var n,o;if(r&&r.status===200){n=new JSZip(r.response);o=n.file(i.replace(/\.zip$/,"")).asText()}return t(e,o)})}return d3.text(e,function(e,i){return t(e,i)})};i.load_data=h;y=function(){h(VIS.files.info,function(e,i){if(typeof i==="string"){t.m.info(JSON.parse(i));VIS.update(t.m.info().VIS);t.bib.options(VIS.bib);d3.selectAll(".model_title").html(t.m.info().title)}else{view.warning("Unable to load model info from "+VIS.files.info)}v();h(VIS.files.meta,function(e,i){if(typeof i==="string"){t.metadata.from_string(i);t.m.set_meta(t.metadata);w()}else{view.error("Unable to load metadata from "+VIS.files.meta)}});h(VIS.files.dt,function(e,i){t.m.set_dt(i,function(e){if(e){w()}else{view.error("Unable to load document topics from "+VIS.files.dt)}})});h(VIS.files.tw,function(e,i){if(typeof i==="string"){t.m.set_tw(i);VIS.topic_hidden=d3.range(t.m.n()).map(function(e){return VIS.hidden_topics.indexOf(e+1)!==-1});view.topic.dropdown(d3.range(t.m.n()).map(function(e){return{topic:e,words:t.m.topic_words(e,VIS.model_view.words),label:t.m.topic_label(e),hidden:VIS.topic_hidden[e]}}));w()}else{view.error("Unable to load topic words from "+VIS.files.tw)}});h(VIS.files.topic_scaled,function(e,i){if(typeof i==="string"){t.m.set_topic_scaled(i)}else{t.m.set_topic_scaled("");d3.select("#nav_model_scaled").classed("disabled",true).select("a").attr("href","#/model/scaled")}w()});w()})};i.load=y;return i};